#!/usr/bin/env bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
PROJECT_DIR="${SCRIPT_DIR}/.."

cd $PROJECT_DIR
. .env

APP_DIR="/apps/minweb"
APP_BIN="./bin/minweb"
APP_NAME="minweb"
PORT="4532"

COMMANDS="""
mkdir -p ${APP_DIR}
cd ${APP_DIR}
. ~/.nvm/nvm.sh
nvm install 18
nvm use 18
npm i -g pnpm@8.12.0
pnpm i
pnpm build
source .env
make stop
make kill
make start
"""

rsync -aP --exclude=".git" --exclude="node_modules" --exclude=".env" --exclude="dist" ./ "${DEPLOY_HOST}:${APP_DIR}"

ssh "${DEPLOY_HOST}" "/bin/bash -c '$COMMANDS'"
