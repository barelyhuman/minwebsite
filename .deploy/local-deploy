#!/usr/bin/env bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
PROJECT_DIR="${SCRIPT_DIR}/.."

cd $PROJECT_DIR
. .env

APP_DIR="/apps/minweb"
APP_BIN="./bin/minweb"
APP_NAME="minweb"

COMMANDS="""
mkdir -p ${APP_DIR}
cd ${APP_DIR}
. ~/.nvm/nvm.sh
npm i
go mod tidy 
go generate .
go build -o ${APP_BIN} .
pm2 stop ${APP_NAME}
pm2 start "${APP_BIN}" --name=${APP_NAME}
"""

rsync -aP --exclude=".git" --exclude="node_modules" --exclude=".env" ./ "${DEPLOY_HOST}:${APP_DIR}"

ssh "${DEPLOY_HOST}" "/bin/bash -c '$COMMANDS'"
